{% extends "base.html" %}
{% block title %}Next{% endblock %}

{% block content %}
<div>
    <h1 class="text-center text-5xl mb-4">Giving Direction</h1>
    <h1 class="text-center mb-8" id="instruction-text"></h1>
    <h2 class="text-center mb-8 text-gray-500" id="template-text"></h2>
    <h1 class="text-center mb-12" id="example-text"></h1>

    <form id="prompt-form" class="max-w-4xl mx-auto mb-8" onsubmit="handleSubmit(event)">
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Prompt (click the OpenAI button to generate):</label>
            <div class="flex gap-4">
                <textarea id="prompt-input" name="prompt" rows="4" placeholder="Enter your prompt here..."
                    class="flex-1 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button type="submit" class="bg-transparent border-none cursor-pointer self-start">
                    <img id="openai-btn" src="/static/open_ai.png" alt="Generate" class="h-16 hover:opacity-80 transition-opacity">
                </button>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Output:</label>
            <textarea id="output-area" rows="8" readonly
                class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50"></textarea>
        </div>
        <script>
            // Content based on tab selection
            const tabContent = {
                'tab1': {
                    instruction: 'No doubt you noticed that you got a creative narrative. But what if you don\'t like it in that style? Let the AI know!',
                    template: 'Create a story where {insert person here} goes to {insert place here} to {insert activity here} in the style of {insert style here}',
                    example: 'Example: Create a story where Batman goes to London to drink tea in the style of Shakespeare'
                },
                'tab2': {
                    instruction: 'The explanation might be too technical or too simple. Guide the AI on how to explain it!',
                    template: 'Explain {insert concept here} as if I\'m {insert audience level here}, including {insert specific aspect here}, using {insert explanation style here}',
                    example: 'Example: "Explain quantum mechanics as if I\'m in 5th grade, including why particles can be in two places at once, using simple analogies"'
                },
                'tab3': {
                    instruction: 'The ideas might not match your preferences. Tell the AI what style or approach you want!',
                    template: 'Give me {insert number here} ideas for {insert topic here} that focus on {insert criteria here}, with a {insert tone/style here} approach',
                    example: 'Example: "Give me 10 ideas for things to do when visiting Boston that focus on historical sites, with a family-friendly approach"'
                },
                'tab4': {
                    instruction: 'The letter might not have the right tone. Specify how formal or casual you want it to be!',
                    template: 'Write a {insert type here} letter to {insert recipient here} about {insert topic here}, focusing on {insert main point here}, in a {insert tone here} tone',
                    example: 'Example: "Write a complaint letter to my city councilman about noisy neighbors, focusing on late-night disturbances, in a respectful but firm tone"'
                }
            };

            // Load saved data or previous page's prompt on page load
            window.addEventListener('DOMContentLoaded', function() {
                const savedPrompt = sessionStorage.getItem('direction_prompt');
                const savedOutput = sessionStorage.getItem('direction_output');
                const previousPrompt = sessionStorage.getItem('clarity_prompt');
                const selectedTab = sessionStorage.getItem('selected_tab') || 'tab1';

                // Load content based on selected tab
                const content = tabContent[selectedTab];
                document.getElementById('instruction-text').textContent = content.instruction;
                document.getElementById('template-text').textContent = content.template;
                document.getElementById('example-text').textContent = content.example;

                if (savedPrompt) {
                    document.getElementById('prompt-input').value = savedPrompt;
                } else if (previousPrompt) {
                    document.getElementById('prompt-input').value = previousPrompt;
                }

                if (savedOutput) {
                    document.getElementById('output-area').value = savedOutput;
                }
            });

            async function handleSubmit(event) {
                event.preventDefault();

                const img = document.getElementById('openai-btn');
                const outputArea = document.getElementById('output-area');
                const promptInput = document.getElementById('prompt-input');
                const prompt = promptInput.value;

                if (!prompt.trim()) return;

                // Save prompt to session storage
                sessionStorage.setItem('direction_prompt', prompt);

                // Start spinner and clear output
                img.style.animation = 'spin 1s linear infinite';
                outputArea.value = '';

                try {
                    const formData = new FormData();
                    formData.append('prompt', prompt);

                    const response = await fetch('/direction/stream', {
                        method: 'POST',
                        body: formData
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        outputArea.value += chunk;
                        outputArea.scrollTop = outputArea.scrollHeight;
                    }

                    // Save output to session storage
                    sessionStorage.setItem('direction_output', outputArea.value);
                } catch (error) {
                    outputArea.value = 'Error: ' + error.message;
                } finally {
                    img.style.animation = '';
                }
            }
        </script>
        <style>
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    </form>

    <div class="flex justify-center gap-4">
        <a href="/clarity" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
            Back
        </a>
        <a href="/format" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Next
        </a>
    </div>
</div>
{% endblock %}